<!DOCTYPE html>

<!-- muovi i suggerimenti sotto? -->

<html>
<!--
<head base href="https://giove.isti.cnr.it/demo/pat/" target="_blank"></head>
-->
<meta name="google-signin-client_id" content="364074354291-pfkuf67b2kv1gu747i396bbcil0nc3f9.apps.googleusercontent.com">

<head>
</head>

<body>

  <div class="splash-login">
    <div class="splash-background"><img class="splash-img" src="src/img/network.jpg" alt="background image"></div>
    <div class="splash-login-text">
      <div class="splash-element"> Welcome! </div>
      <div class="splash-element">Please enter a username:
        <input class="splash-element" id="input-username" type="text" required>
      </div>
      <button class="splash-element" id="button-username" class="pure-button">Ok</button>
    </div>
  </div>

  <div class="site">

    <div class="header">
      <div class="toolbar">
        <div class="site-title-container">
          <h1>Block Rule Composer <i class="fas fa-puzzle-piece"></i></h1>
        </div>

        <div class="utility-buttons-container">
          <div class="user-content">

            <div id="logged-button-section">
              <span id="user-name"></span>
              <button id="suggestor-drop" class="pure-button" type="button">
                Move hint to main
              </button>
              <button id="button-modal-export" class="pure-button" type="button">
                  Export XML
                </button>
              <button id="button-modal-check" class="pure-button" type="button">
                Check rule
              </button>
              <button id="button-modal-save" class="pure-button" type="button">
                Save rule
              </button>
              <button data-micromodal-trigger="modal-2" id="button-modal-get" class="pure-button" type="button">
                Get rules
              </button>
            </div>
          </div>
          <!--
    <div class="login-logout-container">
      <span id="google-signin" class="g-signin2"></span>
      <span id="google-signout" hidden="true"><a id="google-signout-text" href=""></a></span>
    </div>
    -->

        </div>

      </div>
    </div>

    <div class="workspaces-container">
      <div id="main-workspace-div"></div>
      <div id="suggestion-workspace-div"></div>
    </div>

    <div class="support-container">
      <div class="textarea-div">
        <div id="textarea"> </div>
      </div>
      <div class="textarea-div">
        <div id="textarea-2"></div>
      </div>
      
      <!--
      <div class="suggestion-buttons-div">

        <div id="suggestion-menu" class="pure-menu pure-menu-horizontal">
          <ul class="pure-menu-list">
            <li class="pure-menu-item pure-menu-has-children pure-menu-allow-hover">
              <a href="#" id="menuLink1" class="pure-menu-link">Suggestions</a>
              <ul class="pure-menu-children">
                <li id="suggestor-rule" class="pure-menu-item"><a href="#" class="pure-menu-link">Rule</a></li>
                <li id="suggestor-drop" class="pure-menu-item"><a href="#" class="pure-menu-link">Drop to Main</a></li>
                <li id="suggestor-info" class="pure-menu-item"><a href="#" class="pure-menu-link">Info</a></li>
              </ul>
            </li>
          </ul>
        </div>

      </div>
    -->
    </div>


    <xml id="toolbox" style="display: none">
      <category name="Rule blocks">
        <block type="rule"></block>
      </category>

      <category id="trigger_list" name="Trigger list">
      </category>

      <category name="Trigger operators">
        <block type="and"></block>
        <block type="or"></block>
        <block type="group"></block>
      </category>

      <category name="Action list">
      </category>

      <category name="Action operators">
      </category>

    </xml>

    <xml id="startBlocks" style="display: none">
      <block type="rule" inline="false" x="20" y="20">
      </block>
    </xml>


    <!-- modal save rule form -->
    <div class="modal micromodal-slide" id="modal-1" aria-hidden="true">
      <div class="modal__overlay" tabindex="-1" data-micromodal-close>
        <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-1-title">
          <header class="modal__header">
            <h2 class="modal__title" id="modal-1-title">
              Save rule
            </h2>
            <button class="modal__close" aria-label="Close modal" data-micromodal-close></button>
          </header>
          <main class="modal__content" id="modal-1-content">
            <form action="/my-handling-form-page" method="post">
              <div>
                <label for="rule_name">Rule name:</label>
                <input type="text" id="rule_name" name="rule_name" required>
              </div>
              <div>
                <label for="priority">Priority:</label>
                <input type="number" min="1" max="10" id="priority" name="priority">
              </div>
            </form>
          </main>
          <footer class="modal__footer">
            <button id="button-confirm-save" class="pure-button" data-micromodal-close
              aria-label="Save this rule">Save</button>
            <button class="pure-button" data-micromodal-close aria-label="Close this dialog window">Close</button>
          </footer>
        </div>
      </div>
    </div>


    <!-- modal get rule form -->
    <div class="modal micromodal-slide" id="modal-2" aria-hidden="true">
      <div class="modal__overlay" tabindex="-1" data-micromodal-close>
        <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-1-title">
          <header class="modal__header">
            <h2 class="modal__title" id="modal-2-title">
              Get rule
            </h2>
            <button class="modal__close" aria-label="Close modal" data-micromodal-close></button>
          </header>
          <main class="modal__content" id="modal-1-content">
            <p id="rule_list">
            </p>
          </main>
          <footer class="modal__footer">
            <button id="button-confirm-get" class="pure-button" data-micromodal-close
              aria-label="Get this rule">Ok</button>
            <button class="pure-button" data-micromodal-close aria-label="Close this dialog window">Close</button>
            <button id="button-delete" class="pure-button" data-micromodal-close aria-label="Delete this rule">Delete
              rule</button>
              <button id="button-activate" class="pure-button" data-micromodal-close aria-label="Activate this rule">Activate rule</button>
          </footer>
        </div>
      </div>
    </div>

    <!-- modal suggestor explaination -->
    <div class="modal micromodal-slide" id="modal-3" aria-hidden="true">
      <div class="modal__overlay" tabindex="-1" data-micromodal-close>
        <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-1-title">
          <header class="modal__header">
            <h2 class="modal__title" id="modal-3-title">
              Generate example triggers info
            </h2>
            <button class="modal__close" aria-label="Close modal" data-micromodal-close></button>
          </header>
          <main class="modal__content" id="modal-1-content">
            <p> The rule suggestor provides a possible rule starting from the first
              trigger inserted in the "rule" block.
            </p>

            <p> Suggested rule is found by extracting a possibile sequence of triggers from the
              saved rules of all users, and from the matching of this sequence on the other saved rules for extracting
              a possible coherent action (or a sequence of actions).
            </p>

            <p>
              The matching is a weighting of the similarity of the triggers extracted with the triggers
              in other rules, of the similarity of users (based on the frequency of actions used), and
              of the popularity of actions involved.
            </p>
          </main>
          <footer class="modal__footer">
            <button class="pure-button" data-micromodal-close aria-label="Close this dialog window">Close</button>
          </footer>
        </div>
      </div>
    </div>


    <!-- modal activate rule form -->
    <div class="modal micromodal-slide" id="modal-4" aria-hidden="true">
      <div class="modal__overlay" tabindex="-1" data-micromodal-close>
        <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-1-title">
          <header class="modal__header">
            <h2 class="modal__title" id="modal-2-title">
              Activate rule
            </h2>
            <button class="modal__close" aria-label="Close modal" data-micromodal-close></button>
          </header>
          <main class="modal__content" id="modal-1-content">
            <p id="rule_list">
            </p>
          </main>
          <footer class="modal__footer">
            <button id="button-confirm-get" class="pure-button" data-micromodal-close
              aria-label="Get this rule">Ok</button>
            <button class="pure-button" data-micromodal-close aria-label="Close this dialog window">Close</button>
          </footer>
        </div>
      </div>
    </div>

  </div> <!-- site -->
  <!-- local -->

  <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/pure-min.css"
    integrity="sha384-oAOxQR6DkCoMliIh8yFnu25d7Eq/PHS21PClpwjOTeU2jRSq11vu66rf90/cZr47" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="/src/css/micromodal.css">
  <link rel="stylesheet" type="text/css" href="/src/css/main.css">
  <script src="../node_modules/file-saver/dist/FileSaver.js"></script>
  <script src="https://apis.google.com/js/platform.js" async defer></script>
  <script src="https://kit.fontawesome.com/6f52fd3181.js"></script>
  <script src="../node_modules/jquery/dist/jquery.js"></script>
  <script src="../node_modules/micromodal/dist/micromodal.js"></script>
  <script src="../node_modules/blockly/blockly_compressed.js"></script>
  <script src="../node_modules/blockly/javascript_compressed.js"></script>
  <script src="../node_modules/blockly/msg/js/en.js"></script>
  <script src="../node_modules/blockly/blocks/text.js"></script>
  <script src="../node_modules/blockly/blocks/loops.js"></script>
  <script src="../node_modules/blockly/blocks/logic.js"></script>
  <script src="../node_modules/blockly/blocks/lists.js"></script>
  <script src="../node_modules/blockly/blocks/colour.js"></script>
  <script src="../node_modules/blockly/blocks/variables.js"></script>
  <script src="../node_modules/blockly/blocks/variables_dynamic.js"></script>
  <script src="/src/js/staticBlocks.js"></script>
  <script src="/src/js/dynamicBlocks.js"></script>
  <script src="/src/js/colour-gradient.js"></script>

  <script  type="application/javascript"  >
    goog.require('Blockly.zelos.Renderer')
  </script>
  
  
  <script type="module" src="/src/js/main.js"></script>
  <script type="module">
    import * as Login from '/src/js/login.js';
    
    import { saveUserToLocal, checkRule, exportSuggestorRule, exportSuggestorDrop, getWorkspace, exportWorkspace } from '/src/js/main.js';
    import { saveRuleInDB, getAllFromDB, getOneFromDB, deleteRule, activateRule } from '/src/js/database_functs.js';
    import { generateMatrixFromRule, addCurrentMatrixToGlobalMatrix } from '/src/js/blockSuggestor.js';
    import { appendRulesList, getFullRule } from '/src/js/dom_modifiers.js';
    MicroModal.init();

    
    /**
     * Aggiunge un parametro alla funzione assegnata al bottone button-modal-get 
     */
    function addArgsToFunct() {
      appendRulesList("rule_list");
    }

    /**
     * Controlla che il workspace sia nello stato corretto per il salvataggio
     * prima di mostrare la finestra modale di conferma salvataggio
     */
    function saveRuleWrapper() {
      let checkStatus = checkRule();
      if (checkStatus === "OK") {
        document.getElementById('textarea').innerHTML = "";
        document.getElementById('textarea').innerHTML = "Check: " + checkStatus + ", Saving";
        MicroModal.show('modal-1');
      }
      else {
        document.getElementById('textarea').innerHTML = "";
        document.getElementById('textarea').innerHTML = "Can't save: " + checkStatus;
      }
    }

    /**
     * Controlla che la regola attualmente nel workspace sia corretta 
     */
    function checkRuleWrapper() {
      let checkStatus = checkRule();
      document.getElementById('textarea').innerHTML = "";
      document.getElementById('textarea').innerHTML = "Check: " + checkStatus;
    }

    /**
     * Mostra la finestra modale
     */
    function showModalSuggestorInfoWrapper() {
      MicroModal.show('modal-3');
    }

    /**
     * Wrapper per le funzioni di salvataggio dell'utente corrente nel 
     * local storage e per nascondere lo splash screen e mostrare il main
     */
    function saveToLocalWrapper() {
      const userName = document.getElementById('input-username').value;
      if (userName) {
        $('.splash-login').css('display', 'none');
        $(".site").css('visibility', 'visible');
        saveUserToLocal(userName);
      }
    }

    const buttonUsername = document.getElementById("button-username");
    buttonUsername.addEventListener("click", saveToLocalWrapper, false);

    //const suggestorRule = document.getElementById("suggestor-rule");
    //suggestorRule.addEventListener("click", exportSuggestorRule, false);

    const suggestorDrop = document.getElementById("suggestor-drop");
    suggestorDrop.addEventListener("click", exportSuggestorDrop, false);

    //const suggestorInfo = document.getElementById("suggestor-info");
    //suggestorInfo.addEventListener("click", showModalSuggestorInfoWrapper, false);

    const buttonSave = document.getElementById("button-modal-save");
    buttonSave.addEventListener("click", saveRuleWrapper, false);

    const buttonExport = document.getElementById("button-modal-export");
    buttonExport.addEventListener("click", exportWorkspace, false);

    const buttonCheck = document.getElementById("button-modal-check");
    buttonCheck.addEventListener("click", checkRuleWrapper, false);

    const buttonConfirmSave = document.getElementById("button-confirm-save");
    buttonConfirmSave.addEventListener("click", saveRuleInDB, false);

    const buttonGetAll = document.getElementById("button-modal-get");
    buttonGetAll.addEventListener("click", addArgsToFunct, false);

    const buttonGetOne = document.getElementById("button-confirm-get");
    buttonGetOne.addEventListener("click", getFullRule, false);

    const buttonDelete = document.getElementById("button-delete");
    buttonDelete.addEventListener("click", deleteRule, false);

    const buttonActivate = document.getElementById("button-activate");
    buttonActivate.addEventListener("click", activateRule, false);

    /*
    // API call for Google login
    const googleLoginButton = document.getElementById("google-signin");
    googleLoginButton.addEventListener("click", Login.login, false);

    const googleLogoutButton = document.getElementById("google-signout");
    googleLogoutButton.addEventListener("click", Login.logout, false);

    //check se utente è già loggato, es se fa refresh
    checkLogin();
    */

  </script>

</body>

</html>